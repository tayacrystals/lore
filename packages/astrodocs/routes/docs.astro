---
import { getCollection, render } from "astro:content";
import DocsLayout from "../layouts/DocsLayout.astro";
import { buildSidebar } from "../utils/sidebar";
import { buildToc } from "../utils/toc";
import { flattenSidebar, getPrevNext } from "../utils/navigation";
import config from "virtual:astrodocs/config";

export async function getStaticPaths() {
  const entries = await getCollection("docs", ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: {
      slug: entry.id === "index" ? undefined : entry.id,
    },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const allEntries = await getCollection("docs");
const sidebar = buildSidebar(allEntries, config.sidebar);
const toc = buildToc(headings);
const flatItems = flattenSidebar(sidebar);
const currentPath = Astro.url.pathname.replace(/\/$/, "") || "/docs";
const { prev, next } = getPrevNext(flatItems, currentPath);
---

<DocsLayout
  title={entry.data.title}
  description={entry.data.description}
  sidebar={sidebar}
  toc={toc}
  showToc={entry.data.toc}
  prev={prev}
  next={next}
>
  <Content />
</DocsLayout>
