---
import { Icon } from "astro-icon/components";
import SidebarItem from "./SidebarItem.astro";
import type { SidebarEntry } from "../../utils/sidebar";

interface Props {
  label: string;
  items: SidebarEntry[];
  currentPath: string;
  depth?: number;
}

const { label, items, currentPath, depth = 0 } = Astro.props;

function hasActiveDescendant(entries: SidebarEntry[], path: string): boolean {
  for (const entry of entries) {
    if (entry.type === "link" && entry.href === path) return true;
    if (entry.type === "group" && hasActiveDescendant(entry.items, path)) return true;
  }
  return false;
}

const isOpen = hasActiveDescendant(items, currentPath);
---

{depth === 0 ? (
  <div class="mt-4 first:mt-0">
    <p class="px-2 mb-1 text-xs font-semibold text-fd-foreground/80 tracking-wide">{label}</p>
    <div class="space-y-0.5">
      {items.map((item) =>
        item.type === "link" ? (
          <SidebarItem label={item.label} href={item.href} active={item.href === currentPath} icon={item.icon} />
        ) : (
          <Astro.self label={item.label} items={item.items} currentPath={currentPath} depth={depth + 1} />
        )
      )}
    </div>
  </div>
) : (
  <details class="group/sub" open={isOpen}>
    <summary class="flex items-center gap-1 px-2 py-1.5 text-[13px] font-medium text-fd-muted-foreground hover:text-fd-foreground cursor-pointer select-none list-none [&::-webkit-details-marker]:hidden">
      <Icon name="lucide:chevron-right" class="w-3 h-3 shrink-0 transition-transform group-open/sub:rotate-90" />
      {label}
    </summary>
    <div class="ml-3 pl-2 border-l border-fd-border/50 space-y-0.5 mt-0.5">
      {items.map((item) =>
        item.type === "link" ? (
          <SidebarItem label={item.label} href={item.href} active={item.href === currentPath} icon={item.icon} />
        ) : (
          <Astro.self label={item.label} items={item.items} currentPath={currentPath} depth={depth + 1} />
        )
      )}
    </div>
  </details>
)}
